export function LogPrint(){this.info=t=>console.log(`[layerscoper-info]: ${t}`);this.warn=t=>console.warn(`[layerscoper-warn]: ${t}`);this.error=t=>console.error(`[layerscoper-error]: ${t}`)}const L=new LogPrint();let SM=1;export function setScreenMultiplier(v){SM=v}const addAnimate=({el,animateClass,isInfinite=false})=>{el.classList.add(animateClass);if(isInfinite)return;const n=()=>{el.classList.remove(animateClass);el.removeEventListener("webkitAnimationEnd",n)};el.addEventListener("webkitAnimationEnd",n)};export const bounceVerticalAnimate=el=>addAnimate({el,animateClass:"bounce-verticalcls"});export const bounceHorizonAnimate=el=>addAnimate({el,animateClass:"bounce-horizoncls"});export const backToData=str=>{try{if(str){const o=JSON.parse(str);if(typeof o==="object")return o;L.error("isJson: binddata is not JSON Object");return null}L.info("isJson: binddata is undefined");return null}catch(e){L.error("isJson: error");return null}};const KeyBoard_KeyCode={UP:38,DOWN:40,RIGHT:39,LEFT:37,ENTER:13,BACKSPACE:8,END:35,ESC:27};const RemoteControl_KeyCode={UP:19,DOWN:20,RIGHT:22,LEFT:21,ENTER:23,BACKSPACE:4};export const twoPointDistance=({currentPoint,nextEle})=>{const r1=currentPoint.getBoundingClientRect(),r2=nextEle.getBoundingClientRect(),x1=r1.x+.5*r1.width,y1=r1.y+.5*r1.height,x2=r2.x+.5*r2.width,y2=r2.y+.5*r2.height,dx=x1-x2,dy=y1-y2;return Math.sqrt(dx*dx+dy*dy)};export const twoPointDistanceSameScoped=({currentPoint,nextEle,direct})=>{const y1=currentPoint.getBoundingClientRect().y+.5*currentPoint.getBoundingClientRect().height;const y2=nextEle.getBoundingClientRect().y+.5*nextEle.getBoundingClientRect().height;if(direct==="down"){if(Math.ceil(y2)>Math.ceil(y1)){const x1=currentPoint.getBoundingClientRect().x+.5*currentPoint.getBoundingClientRect().width;const x2=nextEle.getBoundingClientRect().x+.5*nextEle.getBoundingClientRect().width;const a=Math.abs(x1-x2),b=Math.abs(y1-y2);return Math.sqrt(a*a+b*b)}}else if(direct==="up"){if(Math.ceil(y2)<Math.ceil(y1)){const x1=currentPoint.getBoundingClientRect().x+.5*currentPoint.getBoundingClientRect().width;const x2=nextEle.getBoundingClientRect().x+.5*nextEle.getBoundingClientRect().width;const a=Math.abs(x1-x2),b=Math.abs(y1-y2);return Math.sqrt(a*a+b*b)}}return 0};export const scopedCompare=()=> (a,b)=>{const v1=a.attributes['data-scoped'].value,v2=b.attributes['data-scoped'].value;if(v1===v2){L.error(`same scoped number is not allowed, scoped=${v1}`);throw new Error(`Same scoped number is not allowed, scoped=${v1}`)}return v1-v2};export const sortNumber=()=> (a,b)=>a-b;export const runCallbackFn=({currentMap,direct,isBoundary,domEle})=>{if(!currentMap?.callBackFn)return;const _yIdx=currentMap?.stepList.indexOf(currentMap.currentY),_xIdx=currentMap.currentX-1,cbData={locationName:currentMap?.domList[_yIdx]?.[_xIdx]?.attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,isBoundary,dataSource:currentMap?.dataList?.[_yIdx]?.[_xIdx]??null};if(isBoundary&&domEle&&(typeof domEle.isConnected==="undefined"||domEle.isConnected)){L.info(`bounce-${direct}`);if(direct==="left"||direct==="right")bounceHorizonAnimate(domEle);if(direct==="up"||direct==="down")bounceVerticalAnimate(domEle)}switch(direct){case"up":currentMap?.callBackFn?.cbFocusUp&&currentMap?.callBackFn?.cbFocusUp(cbData);break;case"down":currentMap?.callBackFn?.cbFocusDown&&currentMap?.callBackFn?.cbFocusDown(cbData);break;case"left":currentMap?.callBackFn?.cbFocusLeft&&currentMap?.callBackFn?.cbFocusLeft(cbData);break;case"right":currentMap?.callBackFn?.cbFocusRight&&currentMap?.callBackFn?.cbFocusRight(cbData);break;case"backspace":currentMap?.callBackFn?.cbBackSpace&&currentMap?.callBackFn?.cbBackSpace(cbData);break;default:break}};export const isFocusValid=currentMap=>{if(!currentMap?.domList?.length||!currentMap?.stepList?.length)return false;const yIdx=currentMap.stepList.indexOf(currentMap.currentY);if(yIdx===-1)return false;const row=currentMap.domList[yIdx];if(!row||!row.length)return false;const xIdx=currentMap.currentX-1;if(xIdx<0||xIdx>=row.length)return false;const node=row[xIdx];return node&&typeof node.isConnected==="boolean"?node.isConnected:true};export const correctFocusToFirstValid=currentMap=>{if(!currentMap?.domList?.length||!currentMap?.stepList?.length)return false;for(let i=0;i<currentMap.domList.length;i+=1){const row=currentMap.domList[i];if(!row?.length){}else{for(let j=0;j<row.length;j+=1){const node=row[j];if(node&&(typeof node.isConnected==="undefined"||node.isConnected)){currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentY=currentMap.stepList[i];currentMap.currentX=j+1;L.info(`correctFocusToFirstValid: corrected to scope=${currentMap.currentY} x=${currentMap.currentX}`);return true}}}}return false};export const changeCurrentFocus=({currentMap,direct,focusTargetNode})=>{if(!currentMap?.domList?.length||!currentMap?.stepList?.length){L.warn('changeCurrentFocus: currentMap has no domList/stepList');return}const _searchYIndex=currentMap.stepList.indexOf(currentMap.currentY),_lastSearchYIndex=currentMap.stepList.indexOf(currentMap.lastY),row=currentMap.domList[_searchYIndex],currentDom=row?.[currentMap.currentX-1],currentValid=_searchYIndex!==-1&&row&&currentMap.currentX>=1&&currentMap.currentX<=row.length&&currentDom&&(typeof currentDom.isConnected==="undefined"||currentDom.isConnected);if(!currentValid){if(correctFocusToFirstValid(currentMap)){changeCurrentFocus({currentMap,direct:'system'})}return}const lastRow=currentMap.domList[_lastSearchYIndex],lastDom=_lastSearchYIndex!==-1&&lastRow&&currentMap.lastX>=1&&currentMap.lastX<=lastRow.length?lastRow[currentMap.lastX-1]:null,lastValid=lastDom&&(typeof lastDom.isConnected==="undefined"||lastDom.isConnected),isNeedRemember=currentMap.recordList.indexOf(currentMap.currentY)!==-1;L.info(`changeCurrentFocus isNeedRemember:${isNeedRemember} direct:${direct}`);if(isNeedRemember){currentMap.domList[_searchYIndex].forEach((ele,idx)=>{if(ele&&(typeof ele.isConnected==="undefined"||ele.isConnected)){ele.classList.remove('selected');if(!focusTargetNode&&idx===currentMap.currentX-1)ele.classList.add('selected')}});if(focusTargetNode&&(typeof focusTargetNode.isConnected==="undefined"||focusTargetNode.isConnected)){focusTargetNode.classList.add('selected')}else if(row?.[currentMap.currentX-1]){row[currentMap.currentX-1].classList.add('selected')}if(currentMap?.callBackFn?.cbScopeSelectedChange&&typeof currentMap.callBackFn.cbScopeSelectedChange==="function"){const sel=focusTargetNode||currentMap.domList[_searchYIndex]?.[currentMap.currentX-1],selData=currentMap.dataList?.[_searchYIndex]?.[currentMap.currentX-1]??null;currentMap.callBackFn.cbScopeSelectedChange({id:currentMap.controllerId,targetY:currentMap.currentY,targetX:currentMap.currentX,locationName:sel?.attributes?.locationname?.value||'',dataSource:selData})}}if(direct==='system'&&_lastSearchYIndex!==-1&&currentMap.domList[_lastSearchYIndex]?.length>0){currentMap.domList[_lastSearchYIndex].forEach(ele=>{if(ele&&(typeof ele.isConnected==="undefined"||ele.isConnected))ele.classList.remove('focus')})}if(lastValid&&(currentMap.lastY!==-1||currentMap.lastX!==-1)&&direct!=='system'){const lastRowRef=currentMap.domList[_lastSearchYIndex];const isLastNeedRemember=lastRowRef?.[0]?.parentNode?.classList?.value?.indexOf('remembered')!==-1;if(lastRowRef[currentMap.lastX-1])lastRowRef[currentMap.lastX-1].classList.remove('focus');if(isLastNeedRemember&&_searchYIndex===_lastSearchYIndex&&lastRowRef[currentMap.lastX-1])lastRowRef[currentMap.lastX-1].classList.remove('selected')}const focusNode=focusTargetNode||currentMap.domList[_searchYIndex][currentMap.currentX-1];if(focusNode&&(typeof focusNode.isConnected==="undefined"||focusNode.isConnected))focusNode.classList.add('focus');if(currentMap?.callBackFn?.cbFocusChange&&typeof currentMap?.callBackFn?.cbFocusChange==="function"){const yIndex=currentMap?.stepList.indexOf(currentMap.currentY),xIndex=currentMap.currentX-1,currentDom2=focusTargetNode||currentMap?.domList?.[yIndex]?.[xIndex],currentData=currentMap?.dataList?.[yIndex]?.[xIndex]??null,cbData={locationName:currentDom2?.attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentData};currentMap?.callBackFn?.cbFocusChange(cbData)}};export function LayerScoper(){let isInitFinish=false;const controllerIds=[];let wakeUpIndex=0;const updateDebounceTimers={};const UPDATE_DEBOUNCE_MS=32;const controllerMaps={};this.currentScopeScroll=({currentMap,direct})=>{L.info(`currentScopeScroll direct: ${direct}`);const _id=controllerIds[wakeUpIndex];const scrollzoneIndex=currentMap.scrollzoneList&&currentMap.scrollzoneList.indexOf(currentMap.currentY);if(scrollzoneIndex===-1||scrollzoneIndex==null){L.info('currentScopeScroll currentY not in scrollzoneList');return}const scrollzoneDoms=document.getElementById(_id).querySelectorAll('.scrollzone');const outerDom=scrollzoneDoms[scrollzoneIndex];const innerDom=outerDom?.querySelector(':scope > .scoped-incontroll-scroll');if(!outerDom||!innerDom){L.info("currentScopeScroll don't need to scopezone scroll");return}const _currentScoped={outerWidth:outerDom.offsetWidth,outerHeight:outerDom.offsetHeight,innerWidth:innerDom.scrollWidth||innerDom.clientWidth,innerHeight:innerDom.scrollHeight||innerDom.clientHeight};const _yIdx=currentMap.stepList.indexOf(currentMap.currentY);const _row=currentMap.domList[_yIdx];const focusDom=_row?.[currentMap.currentX-1];if(!focusDom||(typeof focusDom.isConnected==="boolean"&& !focusDom.isConnected))return;currentMap.programAutoScrollAction=currentMap.currentY;const relativeFather={focusCenterToFatherTop:focusDom.getBoundingClientRect().top-outerDom.getBoundingClientRect().top+(.5*focusDom.getBoundingClientRect().height),focusCenterToFatherLeft:focusDom.getBoundingClientRect().left-outerDom.getBoundingClientRect().left+(.5*focusDom.getBoundingClientRect().width)};if(_currentScoped.innerHeight>_currentScoped.outerHeight){const cha=relativeFather.focusCenterToFatherTop-(_currentScoped.outerHeight*.5*SM);const scrollVal=((outerDom.scrollTop*SM)+cha)/SM;outerDom.scrollTo(0,scrollVal)}if(_currentScoped.innerWidth>_currentScoped.outerWidth){const cha=relativeFather.focusCenterToFatherLeft-(_currentScoped.outerWidth*.5*SM);const scrollVal=((outerDom.scrollLeft*SM)+cha)/SM;outerDom.scrollTo(Math.max(0,Math.min(scrollVal,outerDom.scrollWidth-outerDom.clientWidth)),0)}setTimeout(()=>{currentMap.programAutoScrollAction=null},200)};this.initDragScroll=containerId=>{if(!containerId){L.warn('initDragScroll: containerId is required');return}const container=document.getElementById(containerId);if(!container){L.warn(`initDragScroll: container with id "${containerId}" not found`);return}const scrollElements=container.querySelectorAll('.scoped-incontroll-scroll');scrollElements.forEach(innerElement=>{const outerElement=innerElement.closest('.scrollzone');if(!outerElement)return;if(outerElement.dataset.dragScrollInitialized==='true')return;let isDragging=false,hasMoved=false,startX=0,startY=0,scrollLeft=0,scrollTop=0,DRAG_THRESHOLD=5;const handleMouseDown=e=>{const target=e.target;if(target.closest('button, a'))return;isDragging=true;hasMoved=false;startX=e.pageX-outerElement.offsetLeft;startY=e.pageY-outerElement.offsetTop;scrollLeft=outerElement.scrollLeft;scrollTop=outerElement.scrollTop};const handleMouseMove=e=>{if(!isDragging)return;const x=e.pageX-outerElement.offsetLeft,y=e.pageY-outerElement.offsetTop,walkX=(x-startX),walkY=(y-startY),distance=Math.sqrt(walkX*walkX+walkY*walkY);if(distance>DRAG_THRESHOLD){if(!hasMoved){hasMoved=true;outerElement.style.userSelect='none'}e.preventDefault();outerElement.scrollLeft=scrollLeft-walkX;outerElement.scrollTop=scrollTop-walkY}};const handleMouseUp=e=>{if(isDragging&&hasMoved){e.preventDefault();e.stopPropagation()}isDragging=false;hasMoved=false;outerElement.style.userSelect=''};const handleMouseLeave=e=>{if(isDragging&&hasMoved){e.preventDefault()}isDragging=false;hasMoved=false;outerElement.style.userSelect=''};let touchHasMoved=false;const handleTouchStart=e=>{if(e.touches.length!==1)return;const target=e.target;if(target.closest('button, a'))return;isDragging=true;touchHasMoved=false;startX=e.touches[0].pageX-outerElement.offsetLeft;startY=e.touches[0].pageY-outerElement.offsetTop;scrollLeft=outerElement.scrollLeft;scrollTop=outerElement.scrollTop};const handleTouchMove=e=>{if(!isDragging||e.touches.length!==1)return;const x=e.touches[0].pageX-outerElement.offsetLeft,y=e.touches[0].pageY-outerElement.offsetTop,walkX=(x-startX),walkY=(y-startY),distance=Math.sqrt(walkX*walkX+walkY*walkY);if(distance>DRAG_THRESHOLD){touchHasMoved=true;e.preventDefault();outerElement.scrollLeft=scrollLeft-walkX;outerElement.scrollTop=scrollTop-walkY}};const handleTouchEnd=e=>{if(isDragging&&touchHasMoved){e.preventDefault()}isDragging=false;touchHasMoved=false};outerElement.addEventListener('mousedown',handleMouseDown);document.addEventListener('mousemove',handleMouseMove);document.addEventListener('mouseup',handleMouseUp);outerElement.addEventListener('mouseleave',handleMouseLeave);outerElement.addEventListener('touchstart',handleTouchStart,{passive:false});outerElement.addEventListener('touchmove',handleTouchMove,{passive:false});outerElement.addEventListener('touchend',handleTouchEnd);outerElement.addEventListener('touchcancel',handleTouchEnd);outerElement.dataset.dragScrollInitialized='true';L.info(`initDragScroll: drag scroll initialized for element in container "${containerId}"`)})};this.currentMapScroll=()=>{const _id=controllerIds[wakeUpIndex];const currentMap=controllerMaps[_id];if(!currentMap.needScroll||(currentMap.needScroll&&!currentMap.scrollDirection)){L.info('currentMapScroll: dont needScroll');return}if(currentMap.needScroll&&!currentMap.scrollDirection){L.error('currentMapScroll: scrollDirection is null');return}const outerDom=document.getElementById(_id);const innerDom=outerDom.querySelector(':scope > .map-incontroll-scroll');currentMap.scrollData.outerWidth=outerDom.offsetWidth;currentMap.scrollData.outerHeight=outerDom.offsetHeight;currentMap.scrollData.innerWidth=innerDom.clientWidth;currentMap.scrollData.innerHeight=innerDom.clientHeight;const _yIdxScroll=currentMap.stepList.indexOf(currentMap.currentY);const _rowScroll=currentMap.domList[_yIdxScroll];const focusDom=_rowScroll?.[currentMap.currentX-1];if(!focusDom||(typeof focusDom.isConnected==="boolean"&& !focusDom.isConnected))return;const relativeFather={focusCenterToFatherTop:focusDom.getBoundingClientRect().top-outerDom.getBoundingClientRect().top+(.5*focusDom.getBoundingClientRect().height),focusCenterToFatherLeft:focusDom.getBoundingClientRect().left-outerDom.getBoundingClientRect().left+(.5*focusDom.getBoundingClientRect().width)};if(currentMap.scrollDirection==='vertical'&&currentMap.scrollData.innerHeight>currentMap.scrollData.outerHeight){const cha=relativeFather.focusCenterToFatherTop-(currentMap.scrollData.outerHeight*.5*SM);const scrollVal=((outerDom.scrollTop*SM)+cha)/SM;setTimeout(()=>{outerDom.scrollTo(0,scrollVal)},10);return}if(currentMap.scrollDirection==='horizontal'&&currentMap.scrollData.innerWidth>currentMap.scrollData.outerWidth){const cha=relativeFather.focusCenterToFatherLeft-(currentMap.scrollData.outerWidth*.5*SM);const scrollVal=((outerDom.scrollLeft*SM)+cha)/SM;setTimeout(()=>{outerDom.scrollTo(scrollVal,0)},10)}};this.onFocusDown=()=>{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];if(!currentMap)return; if(!isFocusValid(currentMap)){if(correctFocusToFirstValid(currentMap)){changeCurrentFocus({currentMap,direct:'system'});this.currentScopeScroll({currentMap,direct:'system'});this.currentMapScroll()}return}const _target=document.getElementById(controllerIds[wakeUpIndex]).getElementsByClassName('focus');if(_target[0]?.attributes?.godown?.value&&(typeof currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.godown?.value])==='function'){try{currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.godown?.value]({locationName:_target[0].attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentMap?.dataList?.[currentMap.stepList.indexOf(currentMap.currentY)]?.[currentMap.currentX-1]??null})}catch(e){L.error(`godown error ${e}`)}return}L.info('dont find godown or godown is not a function, use default');const _currentYIndex=currentMap.stepList.indexOf(currentMap.currentY);let flag=0,nearly=0,nearlyNextLine=1/0,remembered=-1;const isTransit=currentMap.transitList.indexOf(currentMap.currentY)!==-1;if(isTransit){currentMap.domList[_currentYIndex].forEach((ele,index)=>{if(!ele||(typeof ele.isConnected!=='undefined'&& !ele.isConnected))return;const _nearlyNextLine=twoPointDistanceSameScoped({currentPoint:currentMap.domList[_currentYIndex][currentMap.currentX-1],nextEle:ele,direct:'down'});if(_nearlyNextLine!==0&&_nearlyNextLine<nearlyNextLine){flag=index;nearlyNextLine=_nearlyNextLine}});if(nearlyNextLine!==0&&nearlyNextLine!==1/0){currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentX=flag+1;L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'down'});this.currentScopeScroll({currentMap,direct:'down'});this.currentMapScroll();runCallbackFn({currentMap,direct:'down',isBoundary:false,domEle:_target[0]});return}}if((_currentYIndex+1)>=currentMap.stepList.length){L.info('触碰下壁');runCallbackFn({currentMap,direct:'down',isBoundary:true,domEle:_target[0]});return}let _findNextIndex=-1;currentMap.stepList.forEach((scopedVal,index)=>{if((_findNextIndex===-1)&&(index>_currentYIndex)&&(currentMap.domList[index].length>0))_findNextIndex=index});if(_findNextIndex===-1){L.info('触碰下壁');runCallbackFn({currentMap,direct:'down',isBoundary:true,domEle:_target[0]});return}currentMap.domList[_findNextIndex].forEach((ele,index)=>{if(!ele||(typeof ele.isConnected!=='undefined'&& !ele.isConnected))return;if(ele.classList.value.indexOf('selected')!==-1)remembered=index;const _nearly=twoPointDistance({currentPoint:currentMap.domList[_currentYIndex][currentMap.currentX-1],nextEle:ele});if(nearly===0||_nearly<nearly){flag=index;nearly=_nearly}});currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;if(remembered!==-1){currentMap.currentY=currentMap.stepList[_findNextIndex];currentMap.currentX=remembered+1}else{currentMap.currentY=currentMap.stepList[_findNextIndex];currentMap.currentX=flag+1}L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'down'});this.currentScopeScroll({currentMap,direct:'down'});this.currentMapScroll();runCallbackFn({currentMap,direct:'down',isBoundary:false,domEle:_target[0]})};this.onFocusUp=()=>{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];if(!currentMap)return; if(!isFocusValid(currentMap)){if(correctFocusToFirstValid(currentMap)){changeCurrentFocus({currentMap,direct:'system'});this.currentScopeScroll({currentMap,direct:'system'});this.currentMapScroll()}return}const _target=document.getElementById(controllerIds[wakeUpIndex]).getElementsByClassName('focus');if(_target[0]?.attributes?.goup?.value&&(typeof currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.goup?.value])==='function'){try{currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.goup?.value]({locationName:_target[0].attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentMap?.dataList?.[currentMap.stepList.indexOf(currentMap.currentY)]?.[currentMap.currentX-1]??null})}catch(e){L.error(`goup error ${e}`)}return}L.info('dont find goup or goup is not a function, use default');const _currentYIndex=currentMap.stepList.indexOf(currentMap.currentY);let flag=0,nearly=0,nearlyUpLine=1/0,remembered=-1;const isTransit=currentMap.transitList.indexOf(currentMap.currentY)!==-1;if(isTransit){currentMap.domList[_currentYIndex].forEach((ele,index)=>{if(!ele||(typeof ele.isConnected!=='undefined'&& !ele.isConnected))return;const _nearlyUpLine=twoPointDistanceSameScoped({currentPoint:currentMap.domList[_currentYIndex][currentMap.currentX-1],nextEle:ele,direct:'up'});if(_nearlyUpLine!==0&&_nearlyUpLine<nearlyUpLine){flag=index;nearlyUpLine=_nearlyUpLine}});if(nearlyUpLine!==0&&nearlyUpLine!==1/0){currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentX=flag+1;L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'up'});this.currentScopeScroll({currentMap,direct:'up'});this.currentMapScroll();runCallbackFn({currentMap,direct:'up',isBoundary:false,domEle:_target[0]});return}}if(_currentYIndex<=0){L.info('触碰上壁');runCallbackFn({currentMap,direct:'up',isBoundary:true,domEle:_target[0]});return}let _findNextIndex=-1;currentMap.stepList.forEach((scopedVal,index)=>{if((index<_currentYIndex)&&(currentMap.domList[index].length>0))_findNextIndex=index});if(_findNextIndex===-1){L.info('触碰上壁');runCallbackFn({currentMap,direct:'up',isBoundary:true,domEle:_target[0]});return}currentMap.domList[_findNextIndex].forEach((ele,index)=>{if(!ele||(typeof ele.isConnected!=='undefined'&& !ele.isConnected))return;if(ele.classList.value.indexOf('selected')!==-1)remembered=index;const _nearly=twoPointDistance({currentPoint:currentMap.domList[_currentYIndex][currentMap.currentX-1],nextEle:ele});if(nearly===0||_nearly<nearly){flag=index;nearly=_nearly}});currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;if(remembered!==-1){currentMap.currentY=currentMap.stepList[_findNextIndex];currentMap.currentX=remembered+1}else{currentMap.currentY=currentMap.stepList[_findNextIndex];currentMap.currentX=flag+1}L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'up'});this.currentScopeScroll({currentMap,direct:'up'});this.currentMapScroll();runCallbackFn({currentMap,direct:'up',isBoundary:false,domEle:_target[0]})};this.onFocusLeft=()=>{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];if(!currentMap)return; if(!isFocusValid(currentMap)){if(correctFocusToFirstValid(currentMap)){changeCurrentFocus({currentMap,direct:'system'});this.currentScopeScroll({currentMap,direct:'system'});this.currentMapScroll()}return}const _target=document.getElementById(controllerIds[wakeUpIndex]).getElementsByClassName('focus');if(_target[0]?.attributes?.goleft?.value&&(typeof currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.goleft?.value])==='function'){try{currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.goleft?.value]({locationName:_target[0].attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentMap?.dataList?.[currentMap.stepList.indexOf(currentMap.currentY)]?.[currentMap.currentX-1]??null})}catch(e){L.error(`goleft error ${e}`)}return}L.info('dont find goleft or goleft is not a function, use default');const _currentYIndex=currentMap.stepList.indexOf(currentMap.currentY);const isOpenBoundary=currentMap.openBoundaryList.indexOf(currentMap.currentY)!==-1;if(isOpenBoundary&&(currentMap.currentX===1)){let _findNextIndex=-1;currentMap.stepList.forEach((scopedVal,index)=>{if((index<_currentYIndex)&&(currentMap.domList[index].length>0))_findNextIndex=index});if(_findNextIndex===-1){L.info('触碰左壁');runCallbackFn({currentMap,direct:'left',isBoundary:true,domEle:_target[0]});return}currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentY=currentMap.stepList[_findNextIndex];currentMap.currentX=currentMap.domList[_findNextIndex].length;L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'left'});this.currentScopeScroll({currentMap,direct:'left'});this.currentMapScroll();runCallbackFn({currentMap,direct:'left',isBoundary:false,domEle:_target[0]});return}if(currentMap.currentX<=1){L.info('触碰左壁');runCallbackFn({currentMap,direct:'left',isBoundary:true,domEle:_target[0]});return}currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentX-=1;L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'left'});this.currentScopeScroll({currentMap,direct:'left'});this.currentMapScroll();runCallbackFn({currentMap,direct:'left',isBoundary:false,domEle:_target[0]})};this.onFocusRight=()=>{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];if(!currentMap)return; if(!isFocusValid(currentMap)){if(correctFocusToFirstValid(currentMap)){changeCurrentFocus({currentMap,direct:'system'});this.currentScopeScroll({currentMap,direct:'system'});this.currentMapScroll()}return}const _target=document.getElementById(controllerIds[wakeUpIndex]).getElementsByClassName('focus');if(_target[0]?.attributes?.goright?.value&&(typeof currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.goright?.value])==='function'){try{currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.goright?.value]({locationName:_target[0].attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentMap?.dataList?.[currentMap.stepList.indexOf(currentMap.currentY)]?.[currentMap.currentX-1]??null})}catch(e){L.error(`goright error ${e}`)}return}L.info('dont find goright or goright is not a function, use default');const _currentYIndex=currentMap.stepList.indexOf(currentMap.currentY);const isOpenBoundary=currentMap.openBoundaryList.indexOf(currentMap.currentY)!==-1;if(isOpenBoundary&&(currentMap.currentX===currentMap.domList[_currentYIndex].length)){let _findNextIndex=-1;currentMap.stepList.forEach((scopedVal,index)=>{if((_findNextIndex===-1)&&(index>_currentYIndex)&&(currentMap.domList[index].length>0))_findNextIndex=index});if(_findNextIndex===-1){L.info('触碰右壁');runCallbackFn({currentMap,direct:'right',isBoundary:true,domEle:_target[0]});return}currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentY=currentMap.stepList[_findNextIndex];currentMap.currentX=1;L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'right'});this.currentScopeScroll({currentMap,direct:'right'});this.currentMapScroll();runCallbackFn({currentMap,direct:'right',isBoundary:false,domEle:_target[0]});return}if(currentMap.currentX>=currentMap.domList[_currentYIndex].length){L.info('触碰右壁');runCallbackFn({currentMap,direct:'right',isBoundary:true,domEle:_target[0]});return}currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentX+=1;L.info(`currentY ${currentMap.currentY} currentX ${currentMap.currentX}`);changeCurrentFocus({currentMap,direct:'right'});this.currentScopeScroll({currentMap,direct:'right'});this.currentMapScroll();runCallbackFn({currentMap,direct:'right',isBoundary:false,domEle:_target[0]})};this.onFocusKeyEnter=()=>{try{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];if(!currentMap)return; if(!isFocusValid(currentMap)){if(correctFocusToFirstValid(currentMap)){changeCurrentFocus({currentMap,direct:'system'});this.currentScopeScroll({currentMap,direct:'system'});this.currentMapScroll()}return}const _target=document.getElementById(controllerIds[wakeUpIndex]).getElementsByClassName('focus');if(!_target[0])return;if(_target[0]?.attributes?.clickfocus?.value&&(typeof currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.clickfocus?.value])==='function'){currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.clickfocus?.value]({locationName:_target[0].attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentMap?.dataList?.[currentMap.stepList.indexOf(currentMap.currentY)]?.[currentMap.currentX-1]??null})}}catch(e){L.error('onFocusKeyEnter error')}};this.onFocusMouseClick=domObj=>{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];const eventCurrentTarget=domObj?.currentTarget;if(!eventCurrentTarget)return;const _target=eventCurrentTarget;try{if(currentMap.currentY!==parseFloat(_target.attributes?.y.value)||currentMap.currentX!==parseFloat(_target.attributes?.x.value)){currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentY=parseFloat(_target.attributes?.y.value);currentMap.currentX=parseFloat(_target.attributes?.x.value);changeCurrentFocus({currentMap,direct:'click',focusTargetNode:_target});this.currentScopeScroll({currentMap,direct:'click'});this.currentMapScroll()}if(_target?.attributes?.clickfocus?.value&&(typeof currentMap?.selfDefinedCallBackFn[_target?.attributes?.clickfocus?.value])==='function'){currentMap?.selfDefinedCallBackFn[_target?.attributes?.clickfocus?.value]({locationName:_target.attributes?.locationname?.value||'',currentY:parseFloat(_target.attributes?.y.value),currentX:parseFloat(_target.attributes?.x.value),lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentMap?.dataList?.[currentMap.stepList.indexOf(parseFloat(_target?.attributes?.y?.value))]?.[parseFloat(_target?.attributes?.x?.value)-1]??null})}}catch(e){L.error(`onFocusMouseClick error ${JSON.stringify(e)}`)}};this.onBackSpace=()=>{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];if(!currentMap)return; if(!isFocusValid(currentMap)){if(correctFocusToFirstValid(currentMap)){changeCurrentFocus({currentMap,direct:'system'});this.currentScopeScroll({currentMap,direct:'system'});this.currentMapScroll()}return}const _target=document.getElementById(controllerIds[wakeUpIndex]).getElementsByClassName('focus');if(!_target[0])return;if(_target[0]?.attributes?.gobackspace?.value&&(typeof currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.gobackspace?.value])==='function'){try{currentMap?.selfDefinedCallBackFn[_target[0]?.attributes?.gobackspace?.value]({locationName:_target[0].attributes?.locationname?.value||'',currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX,dataSource:currentMap?.dataList?.[currentMap.stepList.indexOf(currentMap.currentY)]?.[currentMap.currentX-1]??null})}catch(e){L.error('gobackspace error')}return}L.info('dont find gobackspace or gobackspace is not a function, use default');runCallbackFn({currentMap,direct:'backspace',isBoundary:false,domEle:_target[0]});let keyEventInstalled=false;this.keyEventInstall=()=>{window.onKeyDown=()=>{L.info('onKeyDown: call');this.onFocusDown()};window.onKeyUp=()=>{L.info('onKeyUp: call');this.onFocusUp()};window.onKeyLeft=()=>{L.info('onKeyLeft: call');this.onFocusLeft()};window.onKeyRight=()=>{L.info('onKeyRight: call');this.onFocusRight()};window.onKeyEnter=()=>{L.info('onKeyEnter: call');this.onFocusKeyEnter()};window.onDismissDialog=()=>{L.info('onBackSpace: call');this.onBackSpace()};if(keyEventInstalled)return;keyEventInstalled=true;window.addEventListener('keydown',e=>{const code=e.keyCode;if(code===KeyBoard_KeyCode.UP||code===RemoteControl_KeyCode.UP||code===KeyBoard_KeyCode.DOWN||code===RemoteControl_KeyCode.DOWN||code===KeyBoard_KeyCode.LEFT||code===RemoteControl_KeyCode.LEFT||code===KeyBoard_KeyCode.RIGHT||code===RemoteControl_KeyCode.RIGHT||code===KeyBoard_KeyCode.ENTER||code===RemoteControl_KeyCode.ENTER||code===KeyBoard_KeyCode.BACKSPACE||code===RemoteControl_KeyCode.BACKSPACE||code===KeyBoard_KeyCode.END||code===KeyBoard_KeyCode.ESC){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation()}if((code===KeyBoard_KeyCode.UP)||(code===RemoteControl_KeyCode.UP))window.onKeyUp();if((code===KeyBoard_KeyCode.DOWN)||(code===RemoteControl_KeyCode.DOWN))window.onKeyDown();if((code===KeyBoard_KeyCode.RIGHT)||(code===RemoteControl_KeyCode.RIGHT))window.onKeyRight();if((code===KeyBoard_KeyCode.LEFT)||(code===RemoteControl_KeyCode.LEFT))window.onKeyLeft();if((code===KeyBoard_KeyCode.ENTER)||(code===RemoteControl_KeyCode.ENTER))window.onKeyEnter();if((code===KeyBoard_KeyCode.BACKSPACE)||(code===RemoteControl_KeyCode.BACKSPACE))window.onDismissDialog();if((code===KeyBoard_KeyCode.END)||(code===KeyBoard_KeyCode.ESC))window.onDismissDialog()})};this.addNewLevelData=params=>{controllerIds.push(params?.id);controllerMaps[params.id]={};const creatIndex=controllerIds.indexOf(params?.id);controllerMaps[params.id].needScroll=params?.needScroll||false;if(controllerMaps[params.id].needScroll&&!controllerMaps[params.id].scrollData){controllerMaps[params.id].scrollDirection=params.scrollDirection;controllerMaps[params.id].scrollData={outerWidth:-1,outerHeight:-1,innerWidth:-1,innerHeight:-1};const outerDom=document.getElementById(params.id);if(controllerMaps[params.id].scrollDirection==='vertical'){outerDom.style.overflowY='scroll';outerDom.style.overflowX='hidden'}else if(controllerMaps[params.id].scrollDirection==='horizontal'){outerDom.style.overflowY='hidden';outerDom.style.overflowX='scroll'}else{L.error('addNewLevelData: scrollDirection config error');return}const innerDom=outerDom.querySelector(':scope > .map-incontroll-scroll');if((controllerMaps[params.id].scrollDirection==='horizontal')&&innerDom){innerDom.style.display='inline-block';innerDom.style.width='auto'}else if((controllerMaps[params.id].scrollDirection==='vertical')&&innerDom){L.info('addNewLevelData: scrollDirection is vertical')}else{L.error(`addNewLevelData: "className .map-incontroll-scroll" must at first level childNode for the parent id=${params.id}`);delete controllerMaps[params.id];controllerIds.splice(creatIndex,1);throw new Error(`addNewLevelData: "className .map-incontroll-scroll" must at first level childNode for the parent id=${params.id}`)}if(params.scrollBarConfig&&params.scrollBarConfig.showScrollBar){const style=document.createElement('style');style.type='text/css';style.innerHTML=`#${params.id}::-webkit-scrollbar{width:${params.scrollBarConfig.trackWidth||'8px'};height:${params.scrollBarConfig.trackWidth||'8px'};}#${params.id}::-webkit-scrollbar-track{background:${params.scrollBarConfig.trackBackground||'none'};border-radius:${params.scrollBarConfig.trackBorderRadius||0};}#${params.id}::-webkit-scrollbar-thumb{background:${params.scrollBarConfig.thumbColor||'rgba(255,255,255,0)'};border-radius:${params.scrollBarConfig.thumbBorderRadius||'4px'};border-width:${params.scrollBarConfig.thumbBorderWidth||0};border-color:${params.scrollBarConfig.thumbBorderColor||'none'};border-style:'solid';}#${params.id}::-webkit-scrollbar-thumb:hover{background:${params.scrollBarConfig.thumbHoverColor||'rgba(255,255,255,0)'};}`;document.getElementsByTagName('head')[0].appendChild(style)}else{const style=document.createElement('style');style.type='text/css';style.innerHTML=`#${params.id}::-webkit-scrollbar{display:none;width:0;height:0;}#${params.id}::-webkit-scrollbar-track{display:none;background:none;}#${params.id}::-webkit-scrollbar-thumb{display:none;background:none;}`;document.getElementsByTagName('head')[0].appendChild(style)}}const _scopedList=Array.prototype.slice.call(document.getElementById(controllerIds[creatIndex]).getElementsByClassName('scoped'));try{_scopedList.sort(scopedCompare())}catch(e){delete controllerMaps[params.id];controllerIds.splice(creatIndex,1);throw e}controllerMaps[controllerIds[creatIndex]].domList=[];controllerMaps[controllerIds[creatIndex]].dataList=[];controllerMaps[controllerIds[creatIndex]].stepList=[];controllerMaps[controllerIds[creatIndex]].transitList=[];controllerMaps[controllerIds[creatIndex]].recordList=[];controllerMaps[controllerIds[creatIndex]].openBoundaryList=[];controllerMaps[controllerIds[creatIndex]].scrollzoneList=[];_scopedList.forEach(ele=>{if(ele.querySelectorAll('.incontroll').length>0){controllerMaps[controllerIds[creatIndex]].domList.push([]);controllerMaps[controllerIds[creatIndex]].dataList.push([]);controllerMaps[controllerIds[creatIndex]].stepList.push(parseFloat(ele.attributes['data-scoped'].value));if(ele.classList.value.indexOf('transit')!==-1)controllerMaps[controllerIds[creatIndex]].transitList.push(parseFloat(ele.attributes['data-scoped'].value));if(ele.classList.value.indexOf('remembered')!==-1)controllerMaps[controllerIds[creatIndex]].recordList.push(parseFloat(ele.attributes['data-scoped'].value));if(ele.classList.value.indexOf('openboundary')!==-1)controllerMaps[controllerIds[creatIndex]].openBoundaryList.push(parseFloat(ele.attributes['data-scoped'].value));if(ele.classList.value.indexOf('scrollzone')!==-1)controllerMaps[controllerIds[creatIndex]].scrollzoneList.push(parseFloat(ele.attributes['data-scoped'].value));ele.querySelectorAll('.incontroll').forEach((ele2,index2)=>{ele2.setAttribute('locationname',`ln_${(ele.attributes['data-scoped'].value).toString()}_${(index2+1).toString()}`);ele2.setAttribute('y',parseFloat(ele.attributes['data-scoped'].value));ele2.setAttribute('x',index2+1);ele2.removeEventListener('click',this.onFocusMouseClick);ele2.addEventListener('click',this.onFocusMouseClick);const lastIndex=controllerMaps[controllerIds[creatIndex]].domList.length-1;controllerMaps[controllerIds[creatIndex]].domList[lastIndex].push(ele2);controllerMaps[controllerIds[creatIndex]].dataList[lastIndex].push(backToData(ele2.attributes?.binddata?.value));ele2.removeAttribute('binddata')})}});L.info(`addNewLevelData stepList: ${JSON.stringify(controllerMaps[controllerIds[creatIndex]].stepList)}`);L.info(`addNewLevelData transitList: ${JSON.stringify(controllerMaps[controllerIds[creatIndex]].transitList)}`);L.info(`addNewLevelData recordList: ${JSON.stringify(controllerMaps[controllerIds[creatIndex]].recordList)}`);L.info(`addNewLevelData openBoundaryList: ${JSON.stringify(controllerMaps[controllerIds[creatIndex]].openBoundaryList)}`);L.info(`addNewLevelData scrollzoneList: ${JSON.stringify(controllerMaps[controllerIds[creatIndex]].scrollzoneList)}`);try{const _searchYIndex=controllerMaps[controllerIds[creatIndex]].stepList.indexOf((params.defaultPoint.y));const _searchXValue=controllerMaps[controllerIds[creatIndex]].domList[_searchYIndex][params.defaultPoint.x-1].attributes.x.value;if(_searchYIndex!==-1&&parseFloat(_searchXValue)===params.defaultPoint.x){controllerMaps[controllerIds[creatIndex]].lastY=-1;controllerMaps[controllerIds[creatIndex]].lastX=-1;controllerMaps[controllerIds[creatIndex]].currentY=params.defaultPoint.y;controllerMaps[controllerIds[creatIndex]].currentX=params.defaultPoint.x}}catch(e){L.error(`addNewLevelData default focus y: ${params.defaultPoint.y} x: ${params.defaultPoint.x} is not exist`);delete controllerMaps[params.id];controllerIds.splice(creatIndex,1);L.error('addNewLevelData controller fali to add new level case');return}controllerMaps[controllerIds[creatIndex]].controllerId=params.id;if(params?.callBackFn){controllerMaps[controllerIds[creatIndex]].callBackFn=Object.assign({},params?.callBackFn)}if(params?.selfDefinedCallBackFn){controllerMaps[controllerIds[creatIndex]].selfDefinedCallBackFn=Object.assign({},params?.selfDefinedCallBackFn)}const container=document.getElementById(params.id);if(container&&controllerMaps[controllerIds[creatIndex]].callBackFn?.cbScrollzoneScroll){const mapRef=controllerMaps[controllerIds[creatIndex]];container.querySelectorAll('.scrollzone').forEach(zone=>{if(zone.dataset.scrollzoneScrollBound==='true')return;const targetY=parseFloat(zone.getAttribute('data-scoped'));zone.addEventListener('scroll',()=>{if(mapRef.programAutoScrollAction===targetY){mapRef.programAutoScrollAction=null;return}mapRef.callBackFn.cbScrollzoneScroll({id:params.id,targetY:Number.isFinite(targetY)?targetY:undefined,scrollTop:zone.scrollTop,scrollLeft:zone.scrollLeft})});zone.dataset.scrollzoneScrollBound='true'})}L.info(`addNewLevelData controller add new level case success ${JSON.stringify(controllerMaps[controllerIds[creatIndex]].stepList)} currentY ${controllerMaps[controllerIds[creatIndex]].currentY} currentX ${controllerMaps[controllerIds[creatIndex]].currentX}`)};this.initController=params=>{const safeParams={id:params.id,className:params.className,defaultPoint:params.defaultPoint,needScroll:params.needScroll,scrollDirection:params.scrollDirection,cssUsedScrrenMultipler:params.cssUsedScrrenMultipler,screenMultiplerValue:params.screenMultiplerValue,scrollBarConfig:params.scrollBarConfig,openAnimate:params.openAnimate};L.info(`initController: params = ${JSON.stringify(safeParams)}`);if(isInitFinish)return;if(!params.id||!params.className||!params.defaultPoint.x||!params.defaultPoint.y){L.error('initController: missing necessary init params');return}if(params?.cssUsedScrrenMultipler&&params?.screenMultiplerValue){if(typeof params?.screenMultiplerValue!=='number'||!Number.isFinite(params?.screenMultiplerValue)||params?.screenMultiplerValue<=0){L.error('if cssUsedScrrenMultipler = true , setScreenMultiplier expects a number/float value > 0');return}setScreenMultiplier(params?.screenMultiplerValue)}if(params?.needScroll&&!(params?.scrollDirection==='horizontal'||params?.scrollDirection==='vertical')){L.error('addNewLevelData: value of scrollDirection must use horizontal/vertical');return}if(params?.openAnimate||false){L.info('openAnimate');const animateStyle=document.createElement('style');animateStyle.type='text/css';animateStyle.innerHTML=`@keyframes bounce-vertical{0%,100%{transition-timing-function:cubic-bezier(0.215,.61,.355,1);transform:translateY(0);}15%,40%,75%{transition-timing-function:cubic-bezier(0.215,.61,.355,1);transform:translateY(-3px);}30%,60%,90%{transition-timing-function:cubic-bezier(0.215,.61,.355,1);transform:translateY(3px);}}@keyframes bounce-horizon{0%{transition-timing-function:cubic-bezier(0.215,.61,.355,1);transform:translateX(0);}15%,40%,75%{transition-timing-function:cubic-bezier(0.215,.61,.355,1);transform:translateX(-3px);}30%,60%,90%{transition-timing-function:cubic-bezier(0.215,.61,.355,1);transform:translateX(3px);}}.anti-shake::before{content:'.';position:absolute;color:transparent;font-size:1rem;line-height:1rem}.bounce-verticalcls{animation:bounce-vertical 700ms}.bounce-horizoncls{animation:bounce-horizon 700ms}`;document.getElementsByTagName('head')[0].appendChild(animateStyle)}try{this.addNewLevelData(params)}catch(e){return}wakeUpIndex=0;changeCurrentFocus({currentMap:controllerMaps[controllerIds[wakeUpIndex]]});this.keyEventInstall();this.initDragScroll(params.id);isInitFinish=true;const currentMap=controllerMaps[controllerIds[wakeUpIndex]];const safeMap={stepList:currentMap.stepList,transitList:currentMap.transitList,recordList:currentMap.recordList,openBoundaryList:currentMap.openBoundaryList,scrollzoneList:currentMap.scrollzoneList,lastY:currentMap.lastY,lastX:currentMap.lastX,currentY:currentMap.currentY,currentX:currentMap.currentX,needScroll:currentMap.needScroll,scrollDirection:currentMap.scrollDirection};L.info(`initController init finish  ${JSON.stringify(safeMap)}`)};this.addNewLayer=params=>{if(!isInitFinish)return;if(!params.id||!params.className||!params.defaultPoint.x||!params.defaultPoint.y){L.error('init error: missing necessary add params');return}this.addNewLevelData(params);this.initDragScroll(params.id)};const doUpdatePayload=(id,needUpdateScoped)=>{L.info(`updateData: needUpdateScoped：${needUpdateScoped}`);if(!isInitFinish||controllerIds.indexOf(id)===-1){L.warn(`updateData: don't init finished or ${id} is not exist`);return}const container=document.getElementById(id);if(!container){L.warn(`updateData: container id=${id} not found`);return}const _scopedList=Array.prototype.slice.call(container.getElementsByClassName('scoped'));const updateIndex=controllerMaps[id].stepList.indexOf(needUpdateScoped);const _updateDomList=[];const _updateDataList=[];let _matchScopedValue=false,_needRecord=false,_needTransit=false,_needOpenBoundary=false,_needScrollzone=false;_scopedList.forEach(ele=>{if(ele.attributes['data-scoped'].value===needUpdateScoped.toString()){_matchScopedValue=true;if(ele.classList.value.indexOf('remembered')!==-1)_needRecord=true;if(ele.classList.value.indexOf('transit')!==-1)_needTransit=true;if(ele.classList.value.indexOf('openboundary')!==-1)_needOpenBoundary=true;if(ele.classList.value.indexOf('scrollzone')!==-1)_needScrollzone=true;if(ele.querySelectorAll('.incontroll').length>0){ele.querySelectorAll('.incontroll').forEach((ele2,index2)=>{ele2.setAttribute('locationname',`ln_${needUpdateScoped.toString()}_${(index2+1).toString()}`);ele2.setAttribute('y',needUpdateScoped);ele2.setAttribute('x',index2+1);ele2.removeEventListener('click',this.onFocusMouseClick);ele2.addEventListener('click',this.onFocusMouseClick);_updateDomList.push(ele2);_updateDataList.push(backToData(ele2.attributes?.binddata?.value));ele2.removeAttribute('binddata')})}}});if(_matchScopedValue===false){L.error(`update dont find this dom level point id ${id} needUpdateScoped ${needUpdateScoped}`);return}if(updateIndex===-1){controllerMaps[id].stepList.push(needUpdateScoped);controllerMaps[id].stepList.sort(sortNumber());if(_needRecord){controllerMaps[id].recordList.push(needUpdateScoped);controllerMaps[id].recordList.sort(sortNumber())}if(_needTransit){controllerMaps[id].transitList.push(needUpdateScoped);controllerMaps[id].transitList.sort(sortNumber())}if(_needOpenBoundary){controllerMaps[id].openBoundaryList.push(needUpdateScoped);controllerMaps[id].openBoundaryList.sort(sortNumber())}if(_needScrollzone){controllerMaps[id].scrollzoneList.push(needUpdateScoped);controllerMaps[id].scrollzoneList.sort(sortNumber())}if(needUpdateScoped===controllerMaps[id].stepList[0]){controllerMaps[id].domList.unshift(_updateDomList);controllerMaps[id].dataList.unshift(_updateDataList)}else if(needUpdateScoped===controllerMaps[id].stepList[controllerMaps[id].stepList.length-1]){controllerMaps[id].domList.push(_updateDomList);controllerMaps[id].dataList.push(_updateDataList)}else{const insertIndex=controllerMaps[id].stepList.indexOf(needUpdateScoped);controllerMaps[id].domList.splice(insertIndex,0,_updateDomList);controllerMaps[id].dataList.splice(insertIndex,0,_updateDataList)}}else{const scopedIndex=controllerMaps[id].stepList.indexOf(needUpdateScoped);controllerMaps[id].domList[scopedIndex]=_updateDomList;controllerMaps[id].dataList[scopedIndex]=_updateDataList;if(controllerIds[wakeUpIndex]===id&&controllerMaps[id].currentY!==needUpdateScoped){this.initDragScroll(id);return}if(controllerMaps[id].domList[controllerMaps[id].stepList.indexOf(needUpdateScoped)].length===0){let _systemFindtIndexY=-1;controllerMaps[id].domList.forEach((ele,index)=>{if(ele.length>0&&_systemFindtIndexY===-1)_systemFindtIndexY=index});controllerMaps[id].lastY=controllerMaps[id].currentY;controllerMaps[id].lastX=controllerMaps[id].currentX;controllerMaps[id].currentY=controllerMaps[id].stepList[_systemFindtIndexY];controllerMaps[id].currentX=1}else{controllerMaps[id].lastY=controllerMaps[id].currentY;controllerMaps[id].lastX=controllerMaps[id].currentX;controllerMaps[id].currentY=needUpdateScoped;controllerMaps[id].currentX=1}if(controllerIds[wakeUpIndex]===id){changeCurrentFocus({currentMap:controllerMaps[id],direct:'system'});this.currentScopeScroll({currentMap:controllerMaps[id],direct:'system'});this.currentMapScroll();runCallbackFn({currentMap:controllerMaps[id],direct:'system',isBoundary:false})}}this.initDragScroll(id)};this.update=({id,needUpdateScoped})=>{if(!id||needUpdateScoped==null){L.warn('update: id and needUpdateScoped are required');return}const key=`${id}_${needUpdateScoped}`;if(updateDebounceTimers[key])clearTimeout(updateDebounceTimers[key]);updateDebounceTimers[key]=setTimeout(()=>{delete updateDebounceTimers[key];doUpdatePayload(id,needUpdateScoped)},UPDATE_DEBOUNCE_MS)};this.wakeUp=obj=>{const{id,targetY,targetX}=obj;L.info(`wakeUp id: ${id} current wakeUpIndex: ${wakeUpIndex} next to wakeUpIndex: ${controllerIds.indexOf(id)}`);if(!id||!controllerMaps[id]){L.error('wakeUp id is not exist');return}const _next=controllerMaps[controllerIds[controllerIds.indexOf(id)]];const _targetY=targetY||_next.currentY;const _targetX=targetX||_next.currentX;L.info(`wakeUp _next ${controllerIds[controllerIds.indexOf(id)]}, _targetY: ${_targetY} _targetX: ${_targetX}`);const _currentNewYIndex=_next.stepList.indexOf(_targetY);const targetRow=_next.domList[_currentNewYIndex];const targetFocusNode=targetRow?.[_targetX-1];const targetValid=_currentNewYIndex>=0&&targetFocusNode&&(typeof targetFocusNode.isConnected==="undefined"||targetFocusNode.isConnected);if(targetValid){const currentMap=controllerMaps[controllerIds[wakeUpIndex]];const _currentYIndex=currentMap.stepList.indexOf(currentMap.currentY);const currentRow=currentMap.domList[_currentYIndex];if(currentRow&&currentRow[currentMap.currentX-1])currentRow[currentMap.currentX-1].classList.remove('focus');wakeUpIndex=controllerIds.indexOf(id);const nextMap=controllerMaps[controllerIds[wakeUpIndex]];nextMap.domList[_currentNewYIndex][_targetX-1].classList.add('focus');nextMap.lastY=nextMap.currentY;nextMap.lastX=nextMap.currentX;nextMap.currentY=_targetY;nextMap.currentX=_targetX;setTimeout(()=>{this.currentScopeScroll({currentMap:nextMap,direct:'system'});this.currentMapScroll()},0);const cbData={locationName:nextMap?.domList[nextMap?.stepList.indexOf(nextMap.currentY)][nextMap.currentX-1].attributes?.locationname?.value||'',currentY:nextMap.currentY,currentX:nextMap.currentX,lastY:nextMap.lastY,lastX:nextMap.lastX,dataSource:nextMap?.dataList?.[nextMap?.stepList.indexOf(nextMap.currentY)]?.[nextMap.currentX-1]??null};nextMap?.callBackFn?.cbFocusChange&&nextMap?.callBackFn?.cbFocusChange(cbData)}else{L.error(`wakeUp targetY: ${_targetY} targetX: ${_targetX} is not exist or node not in document in id: ${id}, ensure update() was called after DOM ready`)}};this.goToFocus=params=>{L.info(`gotoFocus params:, ${JSON.stringify(params)}`);if(!params?.targetY||!params?.targetX||typeof params.targetY!=='number'||typeof params.targetX!=='number'){L.error('params:targetY/targetX is necessary and dataType use Number');return}const currentMap=controllerMaps[controllerIds[wakeUpIndex]];if(!currentMap){L.error('goToFocus: no current controller');return}const yIdx=currentMap.stepList.indexOf(params.targetY);if(yIdx===-1){L.error('this point targetY is not exist in current level case');return}const row=currentMap.domList[yIdx];const targetNode=row?.[params.targetX-1];if(!targetNode){L.error('this point targetX is not exist in current level case');return}if(typeof targetNode.isConnected==='boolean'&&!targetNode.isConnected){L.warn('goToFocus: target node is not in document, call update() after DOM is ready');return}currentMap.lastY=currentMap.currentY;currentMap.lastX=currentMap.currentX;currentMap.currentY=params.targetY;currentMap.currentX=params.targetX;changeCurrentFocus({currentMap,direct:'handler'});this.currentScopeScroll({currentMap,direct:'handler'});this.currentMapScroll();runCallbackFn({currentMap,direct:'handler',isBoundary:false})};this.setScopeSelectedItem=obj=>{if(!obj.id||!obj.targetY||!obj.targetX||typeof obj.targetY!=='number'||typeof obj.targetX!=='number'){L.error('setScopeSelectedItem: missing necessary parameter of id[String]/targetY[Number]/targetX[Number]');return}if(!controllerMaps[obj.id]){L.error(`setScopeSelectedItem: controllerMap-${obj.id} is not exist`);return}const _needChangedMap=controllerMaps[controllerIds[controllerIds.indexOf(obj.id)]];if(_needChangedMap&&_needChangedMap?.recordList.indexOf(obj.targetY)===-1){L.error(`setScopeSelectedItem: scoped-${obj.targetY} is not exist`);return}const _needScopedIndex=_needChangedMap.stepList.indexOf(obj.targetY);const _row=_needChangedMap.domList?.[_needScopedIndex];const _targetNode=_row?.[obj.targetX-1];const _targetValid=_needScopedIndex!==-1&&_row&&_targetNode&&(typeof _targetNode.isConnected==="undefined"||_targetNode.isConnected)&&parseFloat(_targetNode.attributes?.x?.value)===obj.targetX;if(_targetValid){if(_needChangedMap?.recordList.indexOf(obj.targetY)!==-1){_needChangedMap.domList[_needScopedIndex].forEach(ele=>{if(!ele||(typeof ele.isConnected!=='undefined'&& !ele.isConnected))return;ele.classList.remove('selected');if(parseFloat(ele.attributes?.x?.value)===obj.targetX)ele.classList.add('selected')});const selectedEle=_needChangedMap.domList[_needScopedIndex][obj.targetX-1];const selectedData=_needChangedMap.dataList?.[_needScopedIndex]?.[obj.targetX-1]??null;if(_needChangedMap?.callBackFn?.cbScopeSelectedChange&&typeof _needChangedMap.callBackFn.cbScopeSelectedChange==='function'){_needChangedMap.callBackFn.cbScopeSelectedChange({id:obj.id,targetY:obj.targetY,targetX:obj.targetX,locationName:selectedEle?.attributes?.locationname?.value||'',dataSource:selectedData})}}else{L.error(`setScopeSelectedItem: scoped-${obj.targetY} is not set remembered`)}}else if(!_row||_needScopedIndex===-1){L.error(`setScopeSelectedItem: scoped-${obj.targetY}-${obj.targetX} row or index not exist`)}else{L.error(`setScopeSelectedItem: scoped-${obj.targetY}-${obj.targetX} is not exist or node not in document`)}};this.rollingScopeSelectedItemClosestToCenter=(()=>{const self=this,DEBOUNCE_MS=150;let timer=null,lastArgs=null;const run=obj=>{if(!obj.id||!obj.targetY||typeof obj.targetY!=='number'){L.error('rollingScopeSelectedItemClosestToCenter: missing necessary parameter of id[String]/targetY[Number]');return}if(!controllerMaps[obj.id]){L.error(`rollingScopeSelectedItemClosestToCenter: controllerMap-${obj.id} is not exist`);return}const currentMap=controllerMaps[controllerIds[controllerIds.indexOf(obj.id)]];const scrollzoneIndex=currentMap.scrollzoneList&&currentMap.scrollzoneList.indexOf(obj.targetY);if(scrollzoneIndex===-1||scrollzoneIndex==null){L.info('rollingScopeSelectedItemClosestToCenter: targetY not in scrollzoneList');return}const scrollzoneDoms=document.getElementById(obj.id).querySelectorAll('.scrollzone');const outerDom=scrollzoneDoms[scrollzoneIndex];const innerDom=outerDom?.querySelector(':scope > .scoped-incontroll-scroll');if(!outerDom||!innerDom){L.info('rollingScopeSelectedItemClosestToCenter: no scrollzone or inner scroll');return}const items=innerDom.querySelectorAll('.incontroll');if(!items.length)return;const zoneRect=outerDom.getBoundingClientRect();const centerX=zoneRect.left+zoneRect.width/2;const centerY=zoneRect.top+zoneRect.height/2;let closest=null;for(let i=0;i<items.length;i+=1){const rect=items[i].getBoundingClientRect();if(centerX>=rect.left&&centerX<=rect.right&&centerY>=rect.top&&centerY<=rect.bottom){closest=items[i];break}}if(!closest){let minDist=1/0;for(let i=0;i<items.length;i+=1){const rect=items[i].getBoundingClientRect();const cx=rect.left+rect.width/2,const cy=rect.top+rect.height/2;const dist=(centerX-cx)*(centerX-cx)+(centerY-cy)*(centerY-cy);if(dist<minDist){minDist=dist;closest=items[i]}}}if(!closest)return;const targetX=parseFloat(closest.getAttribute('x'));if(!Number.isFinite(targetX))return;self.setScopeSelectedItem({id:obj.id,targetY:obj.targetY,targetX});if(controllerIds[wakeUpIndex]===obj.id){self.goToFocus({targetY:obj.targetY,targetX,skipScopeScroll:true})}};return function(obj){lastArgs=obj;if(timer)clearTimeout(timer);timer=setTimeout(()=>{run(lastArgs);timer=null},DEBOUNCE_MS)}})();this.scopeSelectedItemScrollToMiddle=obj=>{L.info(`scopeSelectedItemScrollToMiddle obj: ${JSON.stringify(obj)}`);if(!obj.id||!obj.targetY||typeof obj.targetY!=='number'){L.error('scopeSelectedItemScrollToMiddle: missing necessary parameter of id[String]/targetY[Number]');return}if(!controllerMaps[obj.id]){L.error(`scopeSelectedItemScrollToMiddle: controllerMap-${obj.id} is not exist`);return}const currentMap=controllerMaps[controllerIds[controllerIds.indexOf(obj.id)]];const scrollzoneIndex=currentMap.scrollzoneList&&currentMap.scrollzoneList.indexOf(obj.targetY);if(scrollzoneIndex===-1||scrollzoneIndex==null){L.info('scopeSelectedItemScrollToMiddle: targetY not in scrollzoneList');return}const scrollzoneDoms=document.getElementById(obj.id).querySelectorAll('.scrollzone');const outerDom=scrollzoneDoms[scrollzoneIndex];const innerDom=outerDom?.querySelector(':scope > .scoped-incontroll-scroll');if(!outerDom||!innerDom){L.info('scopeSelectedItemScrollToMiddle: no scrollzone or inner scroll');return}const selectedDom=innerDom.querySelector('.incontroll.selected');if(!selectedDom){L.info('scopeSelectedItemScrollToMiddle: selected item dom not exist (no .incontroll.selected in this scope)');return}const _currentScoped={outerWidth:outerDom.offsetWidth,outerHeight:outerDom.offsetHeight,innerWidth:innerDom.scrollWidth||innerDom.clientWidth,innerHeight:innerDom.scrollHeight||innerDom.clientHeight};const relativeFather={focusCenterToFatherTop:selectedDom.getBoundingClientRect().top-outerDom.getBoundingClientRect().top+(.5*selectedDom.getBoundingClientRect().height),focusCenterToFatherLeft:selectedDom.getBoundingClientRect().left-outerDom.getBoundingClientRect().left+(.5*selectedDom.getBoundingClientRect().width)};currentMap.programAutoScrollAction=obj.targetY;if(_currentScoped.innerHeight>_currentScoped.outerHeight){const cha=relativeFather.focusCenterToFatherTop-(_currentScoped.outerHeight*.5*SM);const scrollVal=((outerDom.scrollTop*SM)+cha)/SM;outerDom.scrollTo(0,scrollVal)}if(_currentScoped.innerWidth>_currentScoped.outerWidth){const cha=relativeFather.focusCenterToFatherLeft-(_currentScoped.outerWidth*.5*SM);const scrollVal=((outerDom.scrollLeft*SM)+cha)/SM;outerDom.scrollTo(Math.max(0,Math.min(scrollVal,outerDom.scrollWidth-outerDom.clientWidth)),0)}setTimeout(()=>{currentMap.programAutoScrollAction=null},200)};this.getScopeSelectedInfo=obj=>{if(!obj.id||!obj.targetY||typeof obj.targetY!=='number'){L.error('getScopeSelectedInfo: missing necessary parameter of id[String]/targetY[Number]');return null}if(!controllerMaps[obj.id]){L.error(`getScopeSelectedInfo: controllerMap-${obj.id} is not exist`);return null}const currentMap=controllerMaps[controllerIds[controllerIds.indexOf(obj.id)]];const scopedIndex=currentMap.stepList.indexOf(obj.targetY);if(scopedIndex===-1){L.info(`getScopeSelectedInfo: targetY ${obj.targetY} not in stepList`);return null}const row=currentMap.domList[scopedIndex]||[];let selectedDom=null,targetX=-1;row.forEach((ele,idx)=>{if(ele.classList?.contains('selected')){selectedDom=ele;targetX=idx+1}});if(!selectedDom||targetX===-1){L.info(`getScopeSelectedInfo: no selected item in scope ${obj.targetY}`);return null}const locationName=selectedDom.attributes?.locationname?.value||'';const dataSource=currentMap.dataList?.[scopedIndex]?.[targetX-1]??null;return{id:obj.id,targetY:obj.targetY,targetX,locationName,dataSource}};this.getLocationInfo=()=>{const currentMap=controllerMaps[controllerIds[wakeUpIndex]];return{currentY:currentMap.currentY,currentX:currentMap.currentX,lastY:currentMap.lastY,lastX:currentMap.lastX}}}